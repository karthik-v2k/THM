# Breaking RSA - TryHackMe Room Writeup

**Room Link:** https://tryhackme.com/room/breakrsa

---

## Challenge Overview

Breaking RSA is a cryptography challenge focused on exploiting weak RSA key generation. The challenge demonstrates how RSA encryption can be broken when the two prime factors (p and q) used in key generation are very close to each other. This vulnerability can be exploited using **Fermat's Factorization Method**.

---

## Phase I: Active Reconnaissance

### Step 1: Port Scanning

Identify open services running on the target machine using Nmap:

```bash
nmap -A 10.49.170.222
```

**Results:**
- **Port 22/TCP (SSH)**: OpenSSH 8.2p1 Ubuntu 4ubuntu0.13
  - RSA Key Fingerprint: 3072 bits
  - Supports ECDSA and ED25519 keys as well
  
- **Port 80/TCP (HTTP)**: nginx 1.18.0 (Ubuntu)
  - Server running "Jack Of All Trades" application
  
- **Network Distance**: 4 hops
- **Latency**: 0.025 seconds
- **Scan Duration**: 26.76 seconds

**Services Detected:**
- OS: Linux (Ubuntu)
- SSH Protocol: 2.0

---

### Step 2: Web Application Reconnaissance

#### Directory Enumeration

Enumerate web directories to find hidden endpoints:

```bash
gobuster dir --url http://10.49.170.222 -w /home/kvv/SecLists/Discovery/Web-Content/common.txt -t 150
```

**Enumeration Results:**
- **Wordlist Used**: common.txt (4750 entries)
- **Threads**: 150
- **Scan Status**: 100% Complete

**Directories Discovered:**
1. `/development/` (301 Redirect) - Size: 178 bytes
2. `/index.html` (200 OK) - Size: 384 bytes

---

### Step 3: Sensitive File Discovery

The `/development/` directory contains critical files:

**File 1: id_rsa.pub** (4096-bit RSA Public Key)
- Type: OpenSSH format RSA public key
- Key Size: 4096 bits
- Fingerprint (SHA256): DIqTDIhboydTh2QU6i58JP+5aDRnLBPT8GwVun1n0Co
- Algorithm: RSA

**File 2: log.txt** (Contains crucial vulnerability information)
- States that the two RSA prime factors (p and q) are close to each other
- Indicates the key is vulnerable to **Fermat's Factorization Method**

---

## Phase II: Cryptographic Analysis & Exploitation

### Understanding the Vulnerability

### RSA Key Attributes
- **Key Size/Modulus (n)**: The number of bits (e.g., 2048, 4096 bits) for the modulus (n), directly impacting security; larger is stronger but slower.
- **Public Exponent (e)**: A small, public number (often 65537) used for encryption and signature verification.
- **Prime Factors (p & q)**: The two large prime numbers whose product is the modulus (n); essential for key generation and kept secret. 
- **Private Exponent (d)**: The secret exponent used for decryption and signing.Calculated from p, q, and e
```
d \equiv e^{-1} \pmod{(p-1)(q-1)}
```

**Fermat's Factorization Method** exploits the mathematical property that when p and q are very close to each other:

- The difference (p - q) is small
- The average ((p + q) / 2) is close to âˆšn
- This can be found relatively quickly compared to standard factorization

**Mathematical Formula:**
```
n = p Ã— q
âˆšn â‰ˆ (p + q) / 2
```

---

### Step 4: Private Key Creation

#### Python Script for value of Modulus(n)

```python
from Crypto.PublicKey import RSA

public_key = RSA.importKey(open('id_rsa.pub', 'r').read())
print(public_key.n)
```

Modulus extracted from the public key with aforementioned Python code:
```
n = 960343778775549488806716229688022562692463185460664314559819511657255292180827209174624059690060629715513180527734160798185034958883650709727032190772084959116259664047922715427522089353727952666824433207585440395813418471678775572995422248008108462980790558476993362919639516120538362516927622315187274971734081435230079153205750751020642956757117030852053008146976560531583447003355135460359928857010196241497604249151374353653491684214813678136396641706949128453526566651123162138806898116027920918258136713427376775618725136451984896300788465604914741872970173868541940675400325006679662030787570986695243903017923121105483935334289783830664260722704673471688470355268898058414366742781725580377180144541978809005281731232604162936015554289274471523038666760994260315829982230640668811250447030003462317740603204577123985618718687833015332554488836087898084147236609893032121172292368637672349405254772581742883431648376052937332995630141793928654990078967475194724151821689117026010445305375748604757116271353498403318409547515058838447618537811182917198454172161072247021099572638700461507432831248944781465511414308770376182766366160748136532693805002316728842876519091399408672222673058844554058431161474308624683491225222383
```

#### Python Script for the Prime Factors (p & q)

```python
def isqrt(n):
    x = n
    y = (x+n//x)//2
    while (y<x):
        x = y
        y = (x+n//x)//2
    return x

def fermat(n):
    t0=isqrt(n) + 1
    counter = 0
    t = t0 + counter
    temp = isqrt((t*t) - n)
    while ((temp*temp) != ((t*t) -n)):
        counter+=1
        t=t0+counter
        temp = isqrt((t*t)-n)
    s= temp
    p = t + s
    q = t - s
    return p, q

n = 960343778775549488806716229688022562692463185460664314559819511657255292180827209174624059690060629715513180527734160798185034958883650709727032190772084959116259664047922715427522089353727952666824433207585440395813418471678775572995422248008108462980790558476993362919639516120538362516927622315187274971734081435230079153205750751020642956757117030852053008146976560531583447003355135460359928857010196241497604249151374353653491684214813678136396641706949128453526566651123162138806898116027920918258136713427376775618725136451984896300788465604914741872970173868541940675400325006679662030787570986695243903017923121105483935334289783830664260722704673471688470355268898058414366742781725580377180144541978809005281731232604162936015554289274471523038666760994260315829982230640668811250447030003462317740603204577123985618718687833015332554488836087898084147236609893032121172292368637672349405254772581742883431648376052937332995630141793928654990078967475194724151821689117026010445305375748604757116271353498403318409547515058838447618537811182917198454172161072247021099572638700461507432831248944781465511414308770376182766366160748136532693805002316728842876519091399408672222673058844554058431161474308624683491225222383
p,q = fermat(n)

print('[+] First Factor is: ', p)
print('[+] Second Factor is: ', q)
print('[+] Difference between the factors: ', p-q)
```

Prime Factors extracted from the value of Modulus(n) with aforementioned Python code:
```
[+] First Factor is:  30989413979221186440875537962143588279079180657276785773483163084840787431751925008409382782024837335054414229548213487269055726656919580388980384353939415484564294377142773553463724248812140196477077493185374579859773369113593661078143295090153526634169495633688691753691720088511452131593712380121967802013042678209312444897975134224456911144218687330712554564836016616829044029963400114373142702236623994027926718855592051277298418373056707389464234977873660836337340136755093657804153998347162906059312569124331219753644648657722107663012261197728061352359157767204739644300066112274629356310784052940617408518123
[+] Second Factor is:  30989413979221186440875537962143588279079180657276785773483163084840787431751925008409382782024837335054414229548213487269055726656919580388980384353939415484564294377142773553463724248812140196477077493185374579859773369113593661078143295090153526634169495633688691753691720088511452131593712380121967802013042678209312444897975134224456911144218687330712554564836016616829044029963400114373142702236623994027926718855592051277298418373056707389464234977873660836337340136755093657804153998347162906059312569124331219753644648657722107663012261197728061352359157767204739644300066112274629356310784052940617408516621
[+] Difference between the factors:  1502
```
Since the difference of the factors is small, this endorse the Key to be vulnerable to Fermat's Factorization Method


#### Python Script for Private Key Creation

Using Fermat's factorization to generate the private key with all the derived attributes:

```python
from Cryptodome.PublicKey import RSA
import libnum

def genkey(n, e, d, p, q):
    """Generate RSA private key from components"""
    private_key = RSA.construct((n, e, d, p, q), consistency_check=True)
    private_key = private_key.export_key(format='PEM').decode()
    return private_key

# RSA Key Components
n = 960343778775549488806716229688022562692463185460664314559819511657255292180827209174624059690060629715513180527734160798185034958883650709727032190772084959116259664047922715427522089353727952666824433207585440395813418471678775572995422248008108462980790558476993362919639516120538362516927622315187274971734081435230079153205750751020642956757117030852053008146976560531583447003355135460359928857010196241497604249151374353653491684214813678136396641706949128453526566651123162138806898116027920918258136713427376775618725136451984896300788465604914741872970173868541940675400325006679662030787570986695243903017923121105483935334289783830664260722704673471688470355268898058414366742781725580377180144541978809005281731232604162936015554289274471523038666760994260315829982230640668811250447030003462317740603204577123985618718687833015332554488836087898084147236609893032121172292368637672349405254772581742883431648376052937332995630141793928654990078967475194724151821689117026010445305375748604757116271353498403318409547515058838447618537811182917198454172161072247021099572638700461507432831248944781465511414308770376182766366160748136532693805002316728842876519091399408672222673058844554058431161474308624683491225222383

e = 65537

# Prime Factors (recovered from Fermat's factorization)
p = 30989413979221186440875537962143588279079180657276785773483163084840787431751925008409382782024837335054414229548213487269055726656919580388980384353939415484564294377142773553463724248812140196477077493185374579859773369113593661078143295090153526634169495633688691753691720088511452131593712380121967802013042678209312444897975134224456911144218687330712554564836016616829044029963400114373142702236623994027926718855592051277298418373056707389464234977873660836337340136755093657804153998347162906059312569124331219753644648657722107663012261197728061352359157767204739644300066112274629356310784052940617408518123

q = 30989413979221186440875537962143588279079180657276785773483163084840787431751925008409382782024837335054414229548213487269055726656919580388980384353939415484564294377142773553463724248812140196477077493185374579859773369113593661078143295090153526634169495633688691753691720088511452131593712380121967802013042678209312444897975134224456911144218687330712554564836016616829044029963400114373142702236623994027926718855592051277298418373056707389464234977873660836337340136755093657804153998347162906059312569124331219753644648657722107663012261197728061352359157767204739644300066112274629356310784052940617408516621

# Calculate private exponent
d = libnum.invmod(e, (p-1)*(q-1))

# Generate and export private key
private_key = genkey(n, e, d, p, q)
print(private_key)
```

Private Key generated with aforementioned Python code:
```
-----BEGIN RSA PRIVATE KEY-----
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
-----END RSA PRIVATE KEY-----
```

**Key Parameters:**
- **Modulus (n)**: 16360-bit number (approximately 4900 decimal digits)
- **Public Exponent (e)**: 65537 (0x10001)
- **Prime p**: 1024-bit prime
- **Prime q**: 1024-bit prime (nearly identical to p - vulnerability indicator)
- **Private Exponent (d)**: Calculated using modular inverse

---

## Phase III: Remote Access & Flag Capture

### Step 5: SSH Access Using Recovered Key

With the recovered private key, authenticate to the SSH service as root:

```bash
ssh -i private_rsa root@10.49.170.222
```

**Authentication Details:**
- **User**: root
- **Key File**: private_rsa (generated from recovered parameters)
- **Authentication Method**: RSA Public Key Authentication
- **Connection Status**: âœ… Successful

**System Information:**
- **OS**: Ubuntu 20.04.6 LTS
- **Kernel**: Linux 5.15.0-138-generic (x86_64)
- **SSH Access**: Granted to root user
- **Last Login**: May 11, 2025 from 10.23.8.228
- **System Load**: 0.0
- **Memory Usage**: 15%
- **Disk Usage**: 81.4% of 4.84GB

---

### Step 6: Flag Retrieval

```bash
root@ip-10-49-170-222:~# ls
flag  snap
root@ip-10-49-170-222:~# cat flag
```

**ðŸš© FLAG CAPTURED:**
```
breakingRSAissuperfun20220809134031
```

---

## Vulnerability Summary

| Component | Details |
|-----------|---------|
| **Vulnerability Type** | Weak RSA Key Generation |
| **Root Cause** | Prime factors p and q are extremely close in value |
| **Exploitation Method** | Fermat's Factorization Algorithm |
| **Key Size** | 4096-bit RSA key |
| **Severity** | ðŸ”´ CRITICAL |
| **Impact** | Complete cryptographic compromise - private key recovery |

---

## Key Takeaways

1. **RSA Security Depends on p â‰  q**: When prime factors are close, factorization becomes feasible
2. **Fermat's Method**: Highly effective against poorly generated RSA keys
3. **Importance of Key Generation**: Cryptographic libraries must use proper randomization
4. **Cryptanalysis Skills**: Understanding mathematical properties of encryption is crucial
5. **Defense-in-Depth**: Strong cryptography alone isn't enough without proper implementation

---

## References

1. **Fermat's Factorization Algorithm**: https://medium.com/@phiphatchomchit/fermat-factorization-algorithm-can-break-poor-rsa-encryption-3c657848cc87
2. **Breaking RSA Implementation**: https://github.com/amnigam/SharedScripts/tree/main/breakingRSA
3. **RSA Cryptography**: https://en.wikipedia.org/wiki/RSA_(cryptosystem)
4. **PyCryptodome Documentation**: https://pycryptodome.readthedocs.io/

---

**Challenge Completed:** âœ… Flag captured successfully  
**Exploitation Chain:** Web Recon â†’ File Discovery â†’ Cryptanalysis â†’ Key Recovery â†’ SSH Access â†’ System Compromise
